<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Сообщения')}"></head>
<body>
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container mt-4" style="height: 85vh;">
    <div class="row h-100 shadow rounded overflow-hidden bg-white">

        <div class="col-md-4 border-end px-0 d-flex flex-column bg-light">
            <div class="p-3 border-bottom bg-white">
                <h5 class="mb-0">Диалоги</h5>
            </div>
            <div class="list-group list-group-flush overflow-auto flex-grow-1">
                <a th:each="conv : ${conversations}"
                   th:href="@{/messages(partnerId=${conv.partner.id})}"
                   class="list-group-item list-group-item-action d-flex align-items-center py-3"
                   th:classappend="${activePartner != null && activePartner.id == conv.partner.id} ? 'active text-white' : ''">

                    <img th:src="${conv.partner.avatarDisplay}" class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;">
                    <div class="flex-grow-1 min-width-0">
                        <div class="d-flex justify-content-between">
                            <strong th:text="${conv.partner.fullName ?: conv.partner.username}">User</strong>
                            <small th:text="${#temporals.format(conv.lastMessageTime, 'HH:mm dd.MM')}">Time</small>
                        </div>
                        <p class="mb-0 text-truncate opacity-75 small" th:text="${conv.lastMessage}">Last msg...</p>
                    </div>
                    <span th:if="${conv.unreadCount > 0}" class="badge bg-danger rounded-pill ms-2" th:text="${conv.unreadCount}">1</span>
                </a>
            </div>
        </div>

        <div class="col-md-8 px-0 d-flex flex-column h-100">
            <div class="p-3 border-bottom d-flex align-items-center bg-white" th:if="${activePartner}">
                <img th:src="${activePartner.avatarDisplay}" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
                <h5 class="mb-0" th:text="${activePartner.fullName ?: activePartner.username}">Chat User</h5>
            </div>
            <div class="p-3 border-bottom bg-white" th:unless="${activePartner}">
                <h5 class="mb-0 text-muted">Выберите диалог, чтобы начать общение</h5>
            </div>

            <div id="chatHistory" class="flex-grow-1 p-4 overflow-auto bg-light d-flex flex-column" th:if="${activePartner}">
                <div th:each="msg : ${history}"
                     class="d-flex mb-3"
                     th:classappend="${msg.sender.id == currentUser.id} ? 'justify-content-end' : 'justify-content-start'">

                    <div class="card shadow-sm border-0"
                         style="max-width: 75%;"
                         th:classappend="${msg.sender.id == currentUser.id} ? 'bg-primary text-white' : 'bg-white'">
                        <div class="card-body p-2 px-3">
                            <p class="mb-1" th:text="${msg.content}">Text</p>
                            <small class="opacity-75"
                                   style="font-size: 0.7rem;"
                                   th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">10:00</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-white border-top" th:if="${activePartner}">
                <form id="messageForm" class="d-flex">
                    <input type="hidden" id="recipientId" th:value="${activePartner.id}">
                    <input type="text" id="messageInput" class="form-control me-2 rounded-pill" placeholder="Введите сообщение..." autocomplete="off">
                    <button type="submit" class="btn btn-primary rounded-circle" style="width: 45px; height: 45px;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:if="${activePartner}">
    var stompClient = null;
    var recipientId = document.getElementById('recipientId').value;
    var currentUserId = "[[${currentUser.username}]]";

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // Подписываемся на личные сообщения
            stompClient.subscribe('/user/queue/messages', function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        }, function(error) {
            console.error("WebSocket error: " + error);
        });
    }

    function sendMessage(event) {
        event.preventDefault();
        var messageInput = document.getElementById('messageInput');
        var messageContent = messageInput.value.trim();

        if(messageContent && stompClient) {
            var chatMessage = {
                recipientId: recipientId,
                content: messageContent
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = ''; // Очищаем поле ввода сразу
        }
    }

    function showMessage(message) {
        console.log("Received message:", message);

        var history = document.getElementById('chatHistory');
        // Логика: показываем сообщение, если оно от партнера ИЛИ если оно от меня (пришло подтверждение от сервера)
        // Но проверяем, чтобы это сообщение относилось к ТЕКУЩЕМУ открытому чату

        // ID партнера в текущем окне
        var currentPartnerId = parseInt(recipientId);
        var senderId = message.sender.id;
        var msgRecipientId = message.recipient.id;

        // Показывать сообщение если:
        // 1. Отправитель - это текущий партнер (входящее)
        // 2. Отправитель - это я, и получатель - текущий партнер (мое исходящее)

        var shouldShow = (senderId === currentPartnerId) ||
            (message.sender.username === currentUserId && msgRecipientId === currentPartnerId);

        if (shouldShow) {
            var isMe = (message.sender.username === currentUserId);

            var alignClass = isMe ? 'justify-content-end' : 'justify-content-start';
            var colorClass = isMe ? 'bg-primary text-white' : 'bg-white';

            // Форматируем время (просто берем часы и минуты)
            var date = new Date(message.timestamp);
            var timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            var messageElement = `
                <div class="d-flex mb-3 ${alignClass}">
                    <div class="card shadow-sm border-0 ${colorClass}" style="max-width: 75%;">
                        <div class="card-body p-2 px-3">
                            <p class="mb-1">${message.content}</p>
                            <small class="opacity-75" style="font-size: 0.7rem;">${timeString}</small>
                        </div>
                    </div>
                </div>
            `;

            history.insertAdjacentHTML('beforeend', messageElement);
            scrollToBottom();
        }
    }

    function scrollToBottom() {
        var historyDiv = document.getElementById('chatHistory');
        if(historyDiv) {
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }
    }

    document.getElementById('messageForm').addEventListener('submit', sendMessage);

    // Автопрокрутка вниз при загрузке страницы
    window.onload = scrollToBottom;

    connect();
</script>

</body>
</html>