<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:fragment="head(title)">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">BookCrossing</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- Основной фон страницы --- */
        body {
            background: linear-gradient(rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.4)),
            url('/images/main_bg.png') no-repeat center center fixed !important;
            background-size: cover !important;
            min-height: 100vh;
            margin: 0;
            padding-top: 60px; /* Отступ под фиксированную шапку */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(5px);
            z-index: -1;
            pointer-events: none;
        }

        /* --- Верхняя панель (Navbar) --- */
        .top-navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 60px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 25px;
        }

        .user-avatar-nav {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #4682B4;
        }

        /* --- Стили для уведомлений --- */
        .unread-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.6rem;
            padding: 0.25em 0.5em;
        }

        /* --- Бургер-меню --- */
        #menuToggle {
            display: block;
            position: fixed;
            top: 15px;
            left: 25px;
            z-index: 1002;
            user-select: none;
        }
        #menuToggle a { text-decoration: none; color: #232323; transition: color 0.3s ease; }
        #menuToggle a:hover { color: #4682B4; }
        #menuToggle input { display: block; width: 40px; height: 32px; position: absolute; top: -7px; left: -5px; cursor: pointer; opacity: 0; z-index: 2; }
        #menuToggle span { display: block; width: 33px; height: 4px; margin-bottom: 5px; position: relative; background: #333; border-radius: 3px; z-index: 1; transform-origin: 4px 0px; transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0), background 0.5s cubic-bezier(0.77,0.2,0.05,1.0), opacity 0.55s ease; }
        #menuToggle span:first-child { transform-origin: 0% 0%; }
        #menuToggle span:nth-last-child(2) { transform-origin: 0% 100%; }
        #menuToggle input:checked ~ span { opacity: 1; transform: rotate(45deg) translate(-2px, -1px); background: #232323; }
        #menuToggle input:checked ~ span:nth-last-child(3) { opacity: 0; transform: rotate(0deg) scale(0.2, 0.2); }
        #menuToggle input:checked ~ span:nth-last-child(2) { transform: rotate(-45deg) translate(0, -1px); }
        #menu { position: absolute; width: 300px; margin: -100px 0 0 -50px; padding: 125px 50px 50px; background: #ededed; list-style-type: none; transform-origin: 0% 0%; transform: translate(-100%, 0); transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0); box-shadow: 0 0 10px rgba(0,0,0,0.1); height: 100vh; }
        #menu li { padding: 10px 0; font-size: 22px; position: relative; }
        #menuToggle input:checked ~ ul { transform: none; }
    </style>
</head>

<body>

<div th:fragment="navbar">
    <div class="top-navbar">
        <div class="dropdown" sec:authorize="isAuthenticated()">
            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="me-2 d-none d-sm-inline" th:text="${#authentication.principal.username}">Пользователь</span>
                <img th:src="${currentUser != null && currentUser.avatarUrl != null && !currentUser.avatarUrl.isEmpty() ? currentUser.avatarUrl : '/images/usual_avatar.png'}"
                     class="user-avatar-nav" alt="avatar">
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" th:href="@{/profile}"><i class="fas fa-user me-2"></i>Профиль</a></li>
                <li><a class="dropdown-item" th:href="@{/my-books}"><i class="fas fa-book me-2"></i>Мои книги</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form th:action="@{/logout}" method="post" class="px-3">
                        <button type="submit" class="btn btn-sm btn-outline-danger w-100 mt-1">Выйти</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>

    <nav role="navigation">
        <div id="menuToggle">
            <input type="checkbox" id="menuCheckbox" />
            <span></span>
            <span></span>
            <span></span>
            <ul id="menu">
                <li><a th:href="@{/}">Каталог</a></li>
                <li><a th:href="@{/my-books}">Мои книги</a></li>
                <li><a th:href="@{/add-book}">Добавить книгу</a></li>
                <li><a th:href="@{/profile}">Профиль</a></li>
                <li><a href="#">Карта общежития</a></li>
                <li>
                    <a th:href="@{/messages}">
                        Сообщения
                        <span id="global-unread-badge" class="badge rounded-pill bg-danger ms-2" style="display: none;">0</span>
                    </a>
                </li>
                <li style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px;">
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <button type="submit" style="background:none; border:none; padding:0; font-size:22px; cursor:pointer; color:tomato; font-family: inherit;">
                            <i class="fas fa-sign-out-alt"></i> Выйти
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <audio id="notificationSound" preload="auto">
        <source src="/sounds/notify.mp3" type="audio/mpeg">
    </audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        var stompClient = null;
        var currentUserName = /*[[${#authentication.name}]]*/ 'anonymous';

        function connectGlobal() {
            if (currentUserName === 'anonymousUser' || !currentUserName) return;

            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, function (frame) {
                stompClient.subscribe('/user/queue/messages', function (message) {
                    var msgData = JSON.parse(message.body);
                    if (window.location.pathname !== '/messages') {
                        showNotification(msgData);
                        playNotifySound();
                        updateBadge(1);
                    }
                });

                stompClient.subscribe('/user/queue/notifications', function (notification) {
                    var data = JSON.parse(notification.body);
                    showNotification(data);
                    playNotifySound();
                });
            });
        }

        function playNotifySound() {
            var audio = document.getElementById("notificationSound");
            if(audio) audio.play().catch(e => console.log("Sound blocked by browser"));
        }

        function updateBadge(delta) {
            var badge = document.getElementById("global-unread-badge");
            if(!badge) return;
            var current = parseInt(badge.innerText) || 0;
            current += delta;
            badge.innerText = current;
            badge.style.display = current > 0 ? 'inline-block' : 'none';
        }

        function showNotification(data) {
            if (Notification.permission === "granted") {
                var title = data.sender ? "Новое сообщение от " + data.sender.username : "Уведомление";
                var body = data.content || data.body || "У вас новое событие";
                var n = new Notification(title, { body: body, icon: '/images/usual_avatar.png' });
                n.onclick = function() {
                    window.focus();
                    window.location.href = data.link || "/messages";
                };
            }
        }

        if (typeof Notification !== 'undefined' && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        connectGlobal();
    </script>
</div>

</body>
</html>

git add .
git commit -m "Update code"
git push origin main
git push upstream main