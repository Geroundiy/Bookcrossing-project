<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('–ú–æ–∏ –∫–Ω–∏–≥–∏')}"></head>
<body>
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container-fluid px-4 pt-3">

    <!-- Flash-—Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div th:if="${successMessage}"
         class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}"
         class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i><span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="card p-3 mb-4 border-0 shadow-sm" style="border-radius:12px;">
        <form th:action="@{/my-books}" method="get" class="row g-2 align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="query" class="form-control border-start-0"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." th:value="${searchQuery}">
                </div>
            </div>
            <div class="col-md-4">
                <select name="genre" class="form-select" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
                    <option th:each="g : ${genres}"
                            th:value="${g.name()}"
                            th:text="${g.displayValue}"
                            th:selected="${g.name() == selectedGenre}"></option>
                </select>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
            </div>
        </form>
    </div>

    <div class="mb-3">
        <a th:href="@{/add-book}" class="btn btn-success rounded-pill px-4">
            <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
        </a>
    </div>

    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div th:if="${books == null || books.empty}" class="text-center py-5 text-muted">
        <i class="fas fa-book-open" style="font-size:3rem; color:#d1d5db;"></i>
        <p class="mt-3 mb-1">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–Ω–∏–≥</p>
        <a th:href="@{/add-book}" class="btn btn-primary rounded-pill px-4 mt-2">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é</a>
    </div>

    <!-- –°–µ—Ç–∫–∞ -->
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-3"
         th:unless="${books == null || books.empty}">
        <div class="col" th:each="book : ${books}">
            <div class="card h-100 book-card position-relative">

                <span class="badge rounded-pill status-badge"
                      th:text="${book.status.displayValue}"
                      th:classappend="${book.status.name() == 'FREE'} ? 'bg-success' : 'bg-danger'">
                </span>

                <div class="card-img-container">
                    <img th:src="${book.imageDisplay}"
                         class="card-img-top" alt="–û–±–ª–æ–∂–∫–∞" loading="lazy">
                </div>

                <div class="card-body">
                    <h5 class="card-title text-truncate" th:text="${book.title}"></h5>
                    <p class="card-text text-muted small text-truncate" th:text="${book.author}"></p>
                    <span class="badge bg-light text-dark border" th:text="${book.genre}"></span>
                </div>

                <div class="card-footer d-flex flex-column gap-2">
                    <!-- –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å -->
                    <form th:action="@{/book/{id}/status(id=${book.id})}" method="post">
                        <button type="submit" class="btn btn-sm w-100"
                                th:classappend="${book.status.name() == 'FREE'} ? 'btn-outline-warning' : 'btn-outline-success'"
                                th:text="${book.status.name() == 'FREE'} ? '–ü–æ–º–µ—Ç–∏—Ç—å –∑–∞–Ω—è—Ç–æ–π' : '–ü–æ–º–µ—Ç–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–π'">
                        </button>
                    </form>

                    <!-- –£–¥–∞–ª–∏—Ç—å -->
                    <button type="button"
                            class="btn btn-sm btn-outline-danger w-100"
                            onclick="confirmDelete(this)"
                            th:data-book-id="${book.id}"
                            th:data-book-title="${book.title}">
                        <i class="fas fa-trash-alt me-1"></i>–£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-body text-center p-4">
                <div class="mb-3" style="font-size:2.5rem;">üóëÔ∏è</div>
                <h5 class="fw-bold mb-2">–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É?</h5>
                <p class="text-muted small mb-1" id="deleteBookTitle"></p>
                <p class="text-danger small mb-4">–í—Å–µ –æ—Ç–∑—ã–≤—ã —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
                <form id="deleteForm" method="post">
                    <button type="submit" class="btn btn-danger rounded-pill w-100 mb-2">
                        <i class="fas fa-trash-alt me-2"></i>–î–∞, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
                <button type="button" class="btn btn-outline-secondary rounded-pill w-100"
                        data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDelete(btn) {
        document.getElementById('deleteBookTitle').textContent =
            '¬´' + btn.getAttribute('data-book-title') + '¬ª';
        document.getElementById('deleteForm').action =
            '/book/' + btn.getAttribute('data-book-id') + '/delete';
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
</script>
</body>
</html>